<html>

<head>
    <title>IFFSE</title>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.0/gh-fork-ribbon.min.css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="//cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">

    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <style>
        body {
            padding-top: 50px;
        }

        img {
            max-width: 300px;
            height: auto;
            width: auto\9;
            /* ie8 */
        }

        footer {
            background: white;
            padding-top: 30px;
            width: 80%;
            bottom: 0;
            position: fixed;
            font-size: 14px;
            text-align: center;
        }

        .button-black {
            background-color: black;
            border-color: black;
        }

        .button-black.button-clear,
        .button-black.button-outline {
            background-color: transparent;
            color: black;
        }

        .button-black.button-clear {
            border-color: transparent;
        }
    </style>
</head>

<body>
    <a class="github-fork-ribbon left-top" href="//github.com/kendricktan/iffse/" title="Fork me on GitHub">Fork me on GitHub</a>

    <div class="container">

        <!-- Info & stuff -->
        <div class="row">
            <div class="column column-80 column-offset-10">
                <hr/>
                <h2>Instagram Facial Feature Search Engine</h2>
                <span style="text-align: right">
                    <h6>
                        *only photos with tags <em>#selfie</em>, <em>#selfportrait</em>, <em>#dailylook</em>, <em>#selfiesunday</em> are indexed*<br/>
                        read the <a href="//github.com/kendricktan/iffse/">project page</a> to build an IFFSE with custom tags
                    </h6>
                </span>
                <hr/>
            </div>
        </div>

        <!-- Input field -->
        <div class="row">
            <div class="column column-80 column-offset-10">
                <h2>Search</h2>
                <button class="button-black button-outline" onclick="searchInstaPost()" style="float: right">find similar faces</button>
                <div style="overflow: hidden; padding-right: .5em;">
                    <input type="text" style="width: 100%;" placeholder="instagram.com/p/BVbcg5jFPSv/" id="instaPostField"/>
                </div>
            </div>
        </div>

        <br/>
        <br/>

        <!-- Image submitted / similar faces -->
        <div class="row">
            <div class="column column-80 column-offset-10">
                <div id="selectFoundFaceDiv">                                    
                </div>

                <br/>

                <div style="text-align: center">
                    <img width=200px id="selectedFaceImg" />
                </div>

                <br/>

                <h3>Results</h3>

                <div align="center" id="iffseResults">
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row">
            <div style="padding-top: 125px" class="column column-80 column-offset-10">
                <footer class="footer">
                    <p>bitcoin: 14VmTd7Npm27SmJgrg1eUrSPgFEHcMXVGR<br/> ethereum: 0x19Ed10db2960B9B21283FdFDe464e7bF3a87D05D</p>
                </footer>
            </div>
        </div>

    </div>

    <script async="" defer="defer" src="//platform.instagram.com/en_US/embeds.js"></script>

    <script>
        function displayNewFace(selectObj){
            // Set image source
            var img_ = document.getElementById('selectedFaceImg');
            img_.src = "data:image/png;base64," + global_data[selectObj.value]['face']
            
            // Set Results
            var resultsDiv = document.getElementById('iffseResults');
            resultsDiv.innerHTML = '';
            loadInstaEmbedOrdered(global_data[selectObj.value]['shortcodes'])
        }

        // Create new dropdown menu
        function newFacesDropDown(data){
            // Our new dropdown thingo
            // Create new option for our dropdown select thingo
            var selectNode = document.createElement('select');                 
            for (var i in data){
                var op = new Option();
                op.value = i;                
                op.text = 'Person: ' + (parseInt(i) + 1);
                selectNode.options.add(op)
            }
            selectNode.setAttribute('onchange', 'displayNewFace(this)');
            selectNode.id = 'faceDropDown';
            
            // h3 to display results
            var labelNode = document.createElement('h3')
            labelNode.innerText = Object.keys(data).length + " faces found, displaying results for:"        

            // Get our display div and yeah...
            // Clear it and append new stuff
            var selectFoundFaceDiv = document.getElementById('selectFoundFaceDiv');            
            selectFoundFaceDiv.innerHTML = '';
            selectFoundFaceDiv.appendChild(labelNode);
            selectFoundFaceDiv.appendChild(selectNode);

            // Programatically set the 1st index
            var select_ = document.getElementById('faceDropDown');
            select_.value = 0;
            select_.onchange();
        }

        // Search button on click
        function searchInstaPost() {
            var url = document.getElementById('instaPostField').value;
            $.ajax({
                type: 'POST',
                url: '/search',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({
                    'url': url,
                }),
                success: function (data) {    
                    // Using globals because i'm a pleb                
                    global_data = data['data']
                    newFacesDropDown(data['data']);                    
                }
            });
        }

        // Loads instagram post in order of the
        // provided shortcodes
        function loadInstaEmbedOrdered(shortcodes) {
            if (shortcodes.length > 0) {
                $.ajax({
                    type: 'GET',
                    url: 'https://api.instagram.com/oembed/?url=https://www.instagram.com/p/' + shortcodes[0] + '/&hidecaption=0',
                    dataType: 'jsonp',
                    success: function (data) {
                        var resultsDiv = document.getElementById('iffseResults');
                        resultsDiv.innerHTML += data['html'];
                        window.instgrm.Embeds.process()
                    },
                }).done(function () {
                    loadInstaEmbedOrdered(shortcodes.slice(1));
                }).fail(function () {
                    loadInstaEmbedOrdered(shortcodes.slice(1));
                });
            }
        }
    </script>
</body>

</html>